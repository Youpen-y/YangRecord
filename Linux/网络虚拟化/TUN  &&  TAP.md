![[tun-tap 1.png]]
TUN 和 TAP 是操作系统内核实现的虚拟网络设备，Linux 内核通过 TAP/TUN 设备向绑定该设备的用户空间应用程序发送数据；用户空间应用也可以像操作硬件网络设备那样，通过 TAP/TUN 设备发送数据。
> 不同于普通靠硬件网络适配器实现的设备，这些虚拟的网络设备全部由软件实现，并向运行于操作系统上的软件提供与硬件的网络设备完全相同的功能。

TUN/TAP 设备对应的字符设备文件为 `/dev/net/tun` 。内核通过该字符设备文件与用户空间应用传递网络数据，同时，利用网卡驱动部分接收并发送来自 TCP/IP 协议栈的网络数据，或反过来将收到的网络数据传给协议栈处理。

示例：
1. 打开设备文件
```bash
# 用户程序执行类似操作
fd = open("/dev/net/tun", O_RDWR);
```

2. 虚拟网卡的创建
当用户程序打开 `/dev/net/tun` 时，内核的 TUN/TAP 驱动会：
- 创建一个虚拟网络接口
- 将其注册到系统中
- 默认命名为 `tun0`, `tun1`（TUN 设备）或 `tap0`（TAP 设备）

3. 数据交互
用户程序通过 `read()` 和 `write()` 系统调用操作文件描述符。
- `write(fd, data)`：用户程序向虚拟网卡发送数据包
- `read(fd, buffer)`：用户程序从虚拟网卡接收数据包

- TAP （network TAP）模拟于以太网设备，它处理第二层数据包如以太网数据帧。TAP 设备传输完整的以太网帧（包括数据链路层头部），使得用户空间程序可以处理 raw ethernet frame。
- TUN （network TUNnel）模拟了网络层设备，处理第三层数据包如 IP 数据包。使得用户空间程序能够直接收发 IP 数据包。



![[Linux/images/TUN-TAP.png]]
虽然两者都用于隧道（tunneling）目的，但 TUN 和 TAP 不能一起使用，因为它们在网络堆栈的不同层传输和接收数据包。

操作系统通过 TUN/TAP 设备向绑定该设备的用户空间的程序发送数据。用户空间的程序也可以像操作硬件网络设备那样，通过 TUN/TAP 设备发送数据。在这种情况下，TUN/TAP 设备将这些数据包传送（或“注入”）到操作系统堆栈，从而模拟从外部接受数据的过程。 



