1. [Autotools Tutorial](https://www.lrde.epita.fr/~adl/autotools.html)
2. [Autotools Mythbuster](https://autotools.info/?mtm_campaign=homepage&amp;mtm_content=redirects)
3. [The GNU Project Build Tools](https://www.sourceware.org/autobook/autobook/autobook.html#Top)
4. [Recursive Make Considered Harmful](https://aegis.sourceforge.net/auug97.pdf)
5. [Autotools Tutorial for Beginners](http://markuskimius.wikidot.com/programming:tut:autotools/)
6. [Using GNU Autotools - Alexandre Duret-Lutz](https://www.lrde.epita.fr/~adl/dl/autotools.pdf)
7. Autotools: A Practioner's Guide to GNU Autoconf, Automake, and Libtool
8. [GNU Autotools: a tutorial](https://bootlin.com/pub/conferences/2016/elc/petazzoni-autotools-tutorial/petazzoni-autotools-tutorial.pdf)
9. [Adventures in Autoconfiscation](https://www.jezuk.co.uk/tags/autotools.html)
10. [Autoconf](https://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.72/autoconf.html)
11. [Automake](https://www.gnu.org/software/automake/manual/automake.html)
12. [libtool](https://www.gnu.org/software/libtool/manual/libtool.html)
13. pkg-config

---
### Using GNU Autotools
By Alexandre Duret-Lutz

问题：C 程序的移植性问题（标准库在不同平台上、不同版本之间的实现不完全一致；）
- 不同的平台 API 可用性（可用/不可用）
    如 BSD 上的 kqueue 与Linux 上的 epoll
- 相同功能 API 但不同名称或参数
- 行为语义不一致
- 所属库和头文件差异
应对策略：
1. 条件编译（`#if/#else`）
2. 创建替代 macros / 函数（手动编写一些系统库上不存在的函数）
```c
/* 
宏 fseeko ：在调用 fseek() 时检查偏移量 o 是否可以安全转换为 long 类型，如果不能，就设置 error 错误并返回 -1 。为不支持 fseeko 的环境提供兼容实现。
s: 文件指针（FILE*）
o: 偏移量（通常是 off_t 类型）
w: 偏移方式（SEEK_SET/SEEK_CUR/SEEK_END）
*/
#define fseeko(s, o, w) (((o) == (long)(o)) \
        ? fseek(s, o, w) \
        : (error = EOVERFLOW, -1))
```
不过，维护每个系统的 `#define` 集合很麻烦、要求用户给 `Makefile` 添加必要的 `-D, -I, -l` 编译选项任务繁重、复杂的构建过程阻碍了自由软件的接受度。

从1991年起，人们开始为一些 GNU 软件包编写 shell 脚本以自动猜测设置，自此以后，`configure` 脚本逐渐成为 GNU 项目中各个软件包的标准配置工具。

---
#### `configure` 脚本
—— 检测系统是否包含需要的函数、库和工具
`configure` 脚本将
- 生成一个包含很多 `#define` 的 `config.h` 文件
- 生成构建包的 Makefile 。
示例：`attr` （A library for filesystem extended attribute support）包 `configure`  执行
```bash
$ sudo ./configure 
[sudo] password for yongy: 
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a race-free mkdir -p... /usr/bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking whether make supports nested variables... yes
checking whether make supports nested variables... (cached) yes
checking build system type... x86_64-pc-linux-gnu
checking host system type... x86_64-pc-linux-gnu
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether the compiler supports GNU C... yes
checking whether gcc accepts -g... yes
checking for gcc option to enable C11 features... none needed
checking whether gcc understands -c and -o together... yes
checking whether make supports the include directive... yes (GNU style)
checking dependency style of gcc... gcc3
checking for stdio.h... yes
checking for stdlib.h... yes
checking for string.h... yes
checking for inttypes.h... yes
checking for stdint.h... yes
checking for strings.h... yes
checking for sys/stat.h... yes
checking for sys/types.h... yes
checking for unistd.h... yes
checking for wchar.h... yes
checking for minix/config.h... no
checking whether it is safe to define __EXTENSIONS__... yes
checking whether _XOPEN_SOURCE should be defined... no
checking for an ANSI C-conforming const... yes
checking for mode_t... yes
checking for size_t... yes
checking for working alloca.h... yes
checking for alloca... yes
checking whether __attribute__((visibility())) is supported... yes
checking for special C compiler options needed for large files... no
checking for _FILE_OFFSET_BITS value needed for large files... no
checking for ar... ar
checking the archiver (ar) interface... ar
checking how to print strings... printf
checking for a sed that does not truncate output... /usr/bin/sed
checking for grep that handles long lines and -e... /usr/bin/grep
checking for egrep... /usr/bin/grep -E
checking for fgrep... /usr/bin/grep -F
checking for ld used by gcc... /usr/bin/ld
checking if the linker (/usr/bin/ld) is GNU ld... yes
checking for BSD- or MS-compatible name lister (nm)... /usr/bin/nm -B
checking the name lister (/usr/bin/nm -B) interface... BSD nm
checking whether ln -s works... yes
checking the maximum length of command line arguments... 1572864
checking how to convert x86_64-pc-linux-gnu file names to x86_64-pc-linux-gnu format... func_convert_file_noop
checking how to convert x86_64-pc-linux-gnu file names to toolchain format... func_convert_file_noop
checking for /usr/bin/ld option to reload object files... -r
checking for file... file
checking for objdump... objdump
checking how to recognize dependent libraries... pass_all
checking for dlltool... no
checking how to associate runtime and link libraries... printf %s\n
checking for archiver @FILE support... @
checking for strip... strip
checking for ranlib... ranlib
checking command to parse /usr/bin/nm -B output from gcc object... ok
checking for sysroot... no
checking for a working dd... /usr/bin/dd
checking how to truncate binary pipes... /usr/bin/dd bs=4096 count=1
checking for mt... mt
checking if mt is a manifest tool... no
checking for dlfcn.h... yes
checking for objdir... .libs
checking if gcc supports -fno-rtti -fno-exceptions... no
checking for gcc option to produce PIC... -fPIC -DPIC
checking if gcc PIC flag -fPIC -DPIC works... yes
checking if gcc static flag -static works... yes
checking if gcc supports -c -o file.o... yes
checking if gcc supports -c -o file.o... (cached) yes
checking whether the gcc linker (/usr/bin/ld -m elf_x86_64) supports shared libraries... yes
checking whether -lc should be explicitly linked in... no
checking dynamic linker characteristics... GNU/Linux ld.so
checking how to hardcode library paths into programs... immediate
checking whether stripping libraries is possible... yes
checking if libtool supports shared libraries... yes
checking whether to build shared libraries... yes
checking whether to build static libraries... yes
checking whether NLS is requested... yes
checking for msgfmt... /usr/bin/msgfmt
checking for gmsgfmt... /usr/bin/msgfmt
checking for xgettext... /usr/bin/xgettext
checking for msgmerge... /usr/bin/msgmerge
checking for ld used by gcc... /usr/bin/ld -m elf_x86_64
checking if the linker (/usr/bin/ld -m elf_x86_64) is GNU ld... yes
checking for shared library run path origin... done
checking how to run the C preprocessor... gcc -E
checking for CFPreferencesCopyAppValue... no
checking for CFLocaleCopyCurrent... no
checking for GNU gettext in libc... yes
checking whether to use NLS... yes
checking where the gettext function comes from... libc
checking that generated files are newer than configure... done
configure: creating ./config.status
config.status: creating libattr.pc
config.status: creating Makefile
config.status: creating po/Makefile.in
config.status: creating include/config.h
config.status: executing depfiles commands
config.status: executing libtool commands
config.status: executing po-directories commands
config.status: creating po/POTFILES
config.status: creating po/Makefile
config.status: executing include/attr commands
```

---
#### GNU 编码标准
- 程序行为
	- 如何报告错误
	- 标准命令行选项
	- 等等
- 编码风格
- 配置（`configuration`）
- Makefile 惯例
- 等

包的标准安装步骤：
1. 下载并解压
```bash
tar zxf example-1.0.tar.gz
cd example-1.0
```

2. 配置
```bash
./configure
```

3. 构建
```bash
sudo make
sudo make check
sudo make install
```
标准 Makefile 目标：
- `make all`：构建程序、库、文档等（等价于 `make`）
- `make install`：安装需要安装的东西
- `make install-strip`：和 `make install` 做的事情相同，但在安装之后，会额外执行一次 `strip` 操作，把可执行文件中的调试符号（debugging symbols）去掉。
- `make uninstall`：`make install`的相反操作
- `make clean`：清除已经构建的（`make all` 的反面）
- `make distclean`：额外删除 `./configure` 创建的所有东西
- `make check`：运行测试套件（如果有的话）
- `make installcheck`：检查安装的程序或库（如果支持的话）
- `make dist`：创建 `PACKAGE-VERSION.tar.gz`
标准文件系统层次结构：

| Directory variable | Default value      |
| ------------------ | ------------------ |
| `prefix`           | `/usr/local`       |
| `exec-prefix`      | `prefix`           |
| `bindir`           | `exec-prefix/bin`  |
| `libdir`           | `exec-prefix/lib`  |
| `includedir`       | `prefix/include`   |
| `datarootdir`      | `prefix/share`     |
| `datadir`          | `datarootdir`      |
| `mandir`           | `datarootdir/man`  |
| `infodir`          | `datarootdir/info` |

`./configure` 脚本会自动检测你的系统环境（如编译器、库、头文件等），然后生成适合你系统的 `Makefile` 。但也可以通过设置配置变量（configuration variables）来手动指定一些参数，以覆盖检测的结果。通过 `./configure --help` 可查看使用。
示例1：指定安装路径
```bash
./configure --prefix=/opt/myapp
```
示例2：强制指定编译器
```bash
CC=clang ./configure
```

示例3：指定 C 编译器的标志
```bash
CFLAGS="-O2 -Wall" ./configure
```

一些较重要的环境变量：

| 环境变量                  | 含义                                                               |
| --------------------- | ---------------------------------------------------------------- |
| `CC`                  | C 编译器                                                            |
| `C_FLAGS`             | C 编译器标志                                                          |
| `LDFLAGS`             | 链接器标志，如 `-L<lib dir>`， 如果在非标准目录 `<lib dir>` 下有库                  |
| `LIBS`                | 传给链接器的库，如 `-l<library>`                                          |
| `CPPFLAGS`            | C/C++ 预处理器标志，如 `-I<include dir>` ，如果在非标准目录 `<include dir>` 下有头文件 |
| `LF_SYS_LIBRARY_PATH` | 用户定义的运行时库搜索路径                                                    |
| `CPP`                 | C 预处理器                                                           |

更好的构建实践
由于对象文件（Object files）、程序和库都会在 `configure` 脚本所在目录下构建。通常在专用 `build` 目录下执行配置操作。
```bash
tar zxf example-1.0.tar.gz
cd example-1.0
mkdir build && cd build
../configure
make
```
这样源文件将在 `example-1.0/` 下，而构建文件将在 `example-1.0/build/` 下。

---
### `Hello World`
程序结构：
```bash
.
├── configure.ac
├── Makefile.am
└── src
    ├── main.c
    └── Makefile.am
```
各文件内容：
```text
#----------------------
# configure.ac
AC_INIT([helloworld], [1.0], [yongy2022@outlook.com])   # 指定包的"名称、版本号和报告错误的地址"
AM_INIT_AUTOMAKE([foreign -Wall -Werror])   # 初始化 Automake ，打开 Automake 所有警告并将其报告为错误，这是一个外部包
AC_PROG_CC  # 检查 C 编译器
AC_CONFIG_HEADERS([config.h])   # 声明 config.h 作为输出头文件
AC_CONFIG_FILES([Makefile src/Makefile])    # 声明 Makefile 和 src/Makefile 作为输出文件
AC_OUTPUT   # 输出所有声明的文件
#----------------------
# Makefile.am
SUBDIRS = src   # 在 src/ 中递归构建；顶层 Makefile.am 通常很短
#----------------------
# src/Makefile.am
bin_PROGRAMS = hello    # PROGRAMS 将被安装在 bindir
hello_SOURCES = main.c
#----------------------
# src/main.c
#include <config.h>
#include <stdio.h>

int main()
{
    puts("Hello World!");
    puts("This is " PACKAGE_STING ".");
    return 0;
}
```
从模板到文件 —— `autoreconf --install/-i`
![[模板-autoreconf-文件.png]]
执行后目录：
```bash
.
├── aclocal.m4
├── autom4te.cache
│   ├── output.0
│   ├── output.1
│   ├── output.2
│   ├── requests
│   ├── traces.0
│   ├── traces.1
│   └── traces.2
├── compile
├── config.h.in     *
├── configure       *
├── configure.ac
├── depcomp
├── install-sh
├── Makefile.am
├── Makefile.in     *
├── missing
└── src
    ├── main.c
    ├── Makefile.am
    └── Makefile.in *

*：期望的配置文件 
aclocal.m4：在 configure.ac 中使用的三方宏定义
depcomp, install-sh, missing：在构建时使用的辅助工具
autom4te.cache/*：Autotools 缓存文件
```
`autoreconf` 背后：
![[autoreconf 背后.png]]